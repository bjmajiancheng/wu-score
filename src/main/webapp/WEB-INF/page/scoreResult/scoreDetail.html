<!DOCTYPE html>
<html lang="en">
<head>
    <title>积分查询</title>
    #parse("common/header.html")
</head>

<body>
#parse("common/banner.html")

<!-- 主体部分 -->
<div class="integral-main-box">

    <!-- 左部导航 -->
    #parse("common/lefter.html")
    <!-- </script> -->
    <!-- 中间二级导航 -->

    <!-- 内容展示区 -->
    <div class="integral-cont">

        <!-- 积分查询 -->
        <!-- 示例title 面包屑导航 -->
        <div class="integral-grey-title-bar">
            <div class="title-bar-head">积分查询</div>
            <p class="interal-main-btn mr20 fr mt10" id="cancalList">返回</p>
        </div>
        <!-- 内容描述title -->
        <div class="integral-desc-title">
            积分查询
        </div>
        <!-- 积分详情 -->
        <table class="integral-cont-table" style="margin-left:10px;">
            <tr>
                <td width="25%">登记编号: $!{identityInfo.acceptNumber}</td>
                <td width="25%">姓名: ${identityInfo.name}</td>
                <td width="25%">性别:
                    #if(${identityInfo.sex} == 1)
                        男
                    #elseif(${identityInfo.sex} == 2)
                        女
                    #end
                </td>
                <td width="25%">身份证号: ${identityInfo.idNumber}</td>
            </tr>
            <tr>
                <td>单位名称: ${identityInfo.companyName}</td>
                <td></td>
                <td>申报地点：
                    #if(${identityInfo.acceptAddressId} == 1)
                        市区
                    #elseif(${identityInfo.acceptAddressId} == 2)
                        滨海新区
                    #end
                </td>
                <td></td>
            </tr>
            <tr>
                <td class="color-red" colspan="4" style="font-size:18px;font-weight:bold;">
                    #if(${status} == 0)
                    此申请人不予积分落户
                    #end
                </td>
            </tr>
            <!--<tr>
                <td colspan="4">不予落户原因: </td>
            </tr>-->
        </table>

        <div style="clear: both;"></div>
        <table class="integral-table">
            <input type="hidden" value="${identityInfo.id}" id="identityInfoId">
            <input type="hidden" value="${identityInfo.cancelStatus}" id="cancelStatus">
            <input type="hidden" value="${identityInfo.istoreview}" id="istoreview">
            <tr class="cancelFade">
                <td><input type="checkbox" class="choosecheck cancelcheck"></td>
                <td colspan="3"><span style="font-size: 18px;">对取消资格申请复核（勾选左侧勾选框后填写理由）</span><br><input type="text" id="cancelReason" class="toreviewreason" style="width: 100%;display: none" placeholder="请输入这个打分项的申请复核理由，请谨慎填写"></td>
            </tr>
            <tr>
                <th colspan="4" style="background-color:#ffffff"></th>
            </tr>
            <tr>
                <th colspan="4"><front style="color:#0000FF">打分指标列表</front></th>
            </tr>
            <tr>
                <th  class="fadeOrDisplay" width="10%">勾选复核</th>
                <th>序号</th>
                <th>指标项</th>
                <th>分数</th>
            </tr>
            <tbody>
            #foreach (${pbScoreRecord} in ${pbScoreRecords})
            <tr>
                <td  class="fadeOrDisplay"><input type="checkbox" class="choosecheck"></td>
                <td>${velocityCount}</td>
                <td>${pbScoreRecord.indicator_name}<br><input type="text" id="${pbScoreRecord.id}" class="toreviewreason secondchoose"
                                                              style="width: 100%;display: none" placeholder="请输入这个打分项的申请复核理由，请谨慎填写"></td>
                <td>${pbScoreRecord.score_value}</td>
            </tr>
            #end

            </tbody>
        </table>
    </div>
    <input type="button" value="申请复核" id="toreview" style="margin-left: 16%;font-size: large;background-color: #3b8df9;
                                    color: white;margin-top: 2%;height: 30px;width: 120px;border-radius: 15px;">
    <input  class="fadeOrDisplay" type="button" value="提交复核" id="submitreview" style="margin-left: 16%;font-size: large;background-color: #3b8df9;
                                    color: white;margin-top: 2%;height: 30px;width: 120px;border-radius: 15px;">
</div>

<!-- 底部栏 footer -->
#parse("common/footer.html")
</body>
<script type="text/javascript">
    $(function(){
        newCurrPage("searchScore");

        //返回列表
        $("#cancalList").on("click", function(){
            window.location.href = "${rc.contextPath}/pbScoreResult/searchScore.html";
        });

        // 2020年5月19日，申请人打开此页面时，要隐藏掉 1、取消资格时申请复核；2、勾选框；3、提交复核按钮
        $(".fadeOrDisplay").hide();
        $(".cancelFade").hide();

        $.ajax({
            type: "POST",
            url: "${rc.contextPath}/pbScoreResult/getPublishAndQueryTime",
            data: null,
            dataType: "json",
            success: function (result) {
                console.log("result.code:"+result.code);
                if (result.code != 1) {
                    $("#toreview").hide(); // 申请复核的时间过去后，隐藏掉“申请复核”按钮
                }
            }});

    });

    // 不见面复核分数的输入框是比照后台所写
    $(".choosecheck").on("change", function () {
        if($(this).is(":checked")){
            $(this).parent().parent().find("input").eq(1).show();
        }else {
            $(this).parent().parent().find("input").eq(1).hide();
        }
    });

    // 点击申请审核按钮
    // 1、获取手机验证码
    // 2、通过后显示勾选框 checkbox
    $("#toreview").on("click",function () {
        /*
         “申请复核”按钮，点击后出现“是/否”提示。
         提示内容“申请复核将进行短信验证。受短信平台限制，短时间内多次重复点击将导致当日无法收到验证码短信，是否进行短信验证？”
             选项-是“继续进行验证”，选此选项进入验证码短信发送。
             选项-否“暂不验证”，选此选项关闭提示。
         */
        var index = layer.confirm('申请复核将进行短信验证。受短信平台限制，短时间内多次重复点击将导致当日无法收到验证码短信，是否进行短信验证？', {
            btn: ['确认', '取消'] //按钮
        }, function () {

            var identityInfoId = $("#identityInfoId").val(); // 申请人ID
            postResult("/pbScoreResult/reviewPhoneCode",{"identityInfoId":identityInfoId}, function (data) {
                if(data.code==110){
                    layer.msg(data.data);
                    return false;
                }
                layer.prompt({title:'验证码已发送到经办人手机'+data.data+', 请输入短信验证码；请耐心等待接收短信，请勿短时间内多次重复验证，否则将导致当日无法收到验证码短信。',formType:0},function (pass,index) {
                    postResult("/pbScoreResult/validReviewPhoneCode",{"identityInfoId":identityInfoId,"msgCode":pass},function (data) {
                        layer.msg("短信码验证成功", {
                            time: 2000
                        });
                        layer.close(index);
                        // 隐藏掉“申请复核”按钮
                        $("#toreview").hide();
                        // 显示勾选框
                        $(".fadeOrDisplay").show();
                        if($("#cancelStatus").val()==1){
                            $(".cancelFade").show();
                        }

                    });
                });
            });

            layer.close(index);
        }, function () {
            layer.close(index);
        });




    });

    // 申请人提交申请复核的理由
    $("#submitreview").on("click",function () {
        var index = layer.confirm('每个申请人只能提交一次复核申请，请确认是否完成选择', {
            btn: ['提交复核申请', '继续选择'] //按钮
        }, function () {
            /**
             * 1、获取申请人的复核理由，包含2种情况
             *      a、申请人被取消资格，申请复核为什么取消资格；
             *      b、申请人的分数申请复核，申请人复核分值；
             * 2、传到后台的 t_pb_score_record 表中
             */
            var flag = false;
            var flag2 = true;
            var reviewArr = new Array();
            $(".secondchoose").each(function () {
                var scorerecord = $(this).attr("id"); // 指标项ID
                var reason = $(this).val(); // 指标项对应的的复核理由
                console.log($(this).parent().parent().find("input").eq(0).prop("checked")+scorerecord+":---"+reason);
                if($(this).parent().parent().find("input").eq(0).prop("checked")){
                    if (reason==null ||reason=="" ){
                        flag = true;
                    }
                    flag2 = false;
                    reviewArr.push({
                        "id": scorerecord,
                        "toreviewreason" : reason
                    });
                };

            });

            if(flag){
                layer.msg('勾选复核的分数项必须填入复核理由；若没有复核要求，请不要勾选。');
                return false;
            }

            if($("#cancelStatus").val()==1){
                if(!$(".cancelcheck").is(":checked")){
                    layer.msg('对取消资格申请复核（勾选左侧勾选框后填写理由），才能点击“提交复核”按钮。若您没有需要申请复核的项，无需点击。');
                    return false;
                }
            }

            if($("#cancelStatus").val()!=1 && flag2){
                layer.msg('请先勾选复核的分数项并填写复核的理由后，点击“提交复核”。若您没有需要申请复核的项，无需点击。');
                return false;
            }



            var reviewJson = JSON.stringify(reviewArr);
            // 若申请人勾选了申请复核不通过
            var cancelReason = "";
            if($(".cancelcheck").is(":checked")){
                cancelReason = $("#cancelReason").val();
                if(cancelReason==null || cancelReason==""){
                    layer.msg('勾选复核的项必须填入复核理由；若没有复核要求，请不要勾选。');
                    return false;
                }
            }
            var identityInfoId = $("#identityInfoId").val(); // 申请人ID

            postResultData("/pbScoreResult/saveReviewReason",{
                "identityInfoId":identityInfoId,
                "cancelReason":cancelReason,
                "reviewJson":reviewJson
            },function () {
                layer.msg('保存成功!!', {
                    time: 1000
                }, function () {
                    window.location.href = "${rc.contextPath}/identityInfo/index.html";
                });
            });
        }, function () {
            layer.close(index);
        });


    });

</script>

</html>

