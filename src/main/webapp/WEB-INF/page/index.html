<!DOCTYPE html>
<html lang="en">
<head>
    <title>首页</title>
    #parse("common/header.html")
</head>

<body>
#parse("common/banner.html")

<!-- 主体部分 -->
<div class="integral-main-box">

    <!-- 左部导航 -->
    #parse("common/lefter.html")
    <!-- </script> -->
    <!-- 中间二级导航 -->

    <!-- 内容展示区 -->
    <div class="integral-cont">

        <!-- 示例title 面包屑导航 -->
        <div class="integral-grey-title-bar">
            <div class="title-bar-head">居住证积分</div>
            <div class="title-bar-after">申请人列表</div>
        </div>
        <!-- 内容描述title -->
        <div class="integral-desc-title">
            申请人列表
        </div>
        <!--<div style="margin-left:20px;margin-bottom:10px;">今天申请审核剩余名额：<span id="remain"></span></div>-->
        <!-- 表格搜索框和按钮部分 -->
        <div id="app">
            <script type="text/regular" id="identityRows">
                <div class="interal-tab-title-input">
                    <div class="interal-input-title">快速查询</div>
                    <input type="text" name="queryStr" placeholder="按照登记编号、身份证号和姓名进行查询" style="width: 280px;">
                    <div class="interal-input-btn" on-click={this.load()}>查询</div>
                    <!--<div class="interal-input-btn">返回</div>-->
                    <div class="interal-input-btn" id="addApplication">添加申请人</div>
                    <!--<div class="interal-input-btn">批量预约</div>-->
                </div>
                <!-- table2表格部分 -->
                <table class="integral-table">
                    <tr>
                        <th>选择</th>
                        <th>受理编号</th>
                        <th>身份证号</th>
                        <th>姓名</th>
                        <th>性别</th>
                        <th>申请日期</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    {#list identityInfos as identityInfo }
                    <tr class="identityInfoTr">
                        <td>
                            <input type="checkbox" name="identityInfoId" value="{identityInfo.id}" />
                        </td>
                        <td>{identityInfo.acceptNumber}</td>
                        <td>{identityInfo.idNumber}</td>
                        <td>{identityInfo.name}</td>
                        <td>{identityInfo.sexStr}</td>
                        <td>{identityInfo.reservaionDateStr}</td>
                        <td>
                            {\#if identityInfo.reservationStatus == 8}
                                <span>审核中</span>
                            {\#elseif identityInfo.reservationStatus == 0}
                                <span>信息未填写</span>
                            {\#elseif identityInfo.reservationStatus == 1}
                                <span>信息已保存</span>
                            {\#elseif identityInfo.reservationStatus == 2}
                                <span>信息已提交</span>
                            {\#elseif identityInfo.reservationStatus == 3}
                                <span>材料已上传</span>
                            {\#elseif identityInfo.reservationStatus == 4}
                                <span>自助测评补测</span>
                            {\#elseif identityInfo.reservationStatus == 5}
                                <span>自助测评不通过</span>
                            {\#elseif identityInfo.reservationStatus == 6}
                                <span>自助测评通过</span>
                            {\#elseif identityInfo.reservationStatus == 7}
                                <span>预约地点选择完成</span>
                            {\#elseif identityInfo.reservationStatus == 9}
                                <span>联合预审不通过</span>
                            {\#elseif identityInfo.reservationStatus == 10}
                                {\#if identityInfo.reservationTime > 0}
                                <span>网上预审通过</span>
                                {\#elseif identityInfo.reservationTime <= 0}
                                <span>取消预约超限</span>
                                {/if}
                            {\#elseif identityInfo.reservationStatus == 11}
                                {\#if identityInfo.policeApproveStatus == 1 && (identityInfo.rensheAcceptStatus == 1  || identityInfo.rensheAcceptStatus == 5)}
                                    <span>审核中</span>
                                {\#elseif identityInfo.policeApproveStatus == 1 && identityInfo.rensheAcceptStatus == 2}
                                    <span>公安审核中</span><br>
                                    <span>人社要求补正</span>
                                {\#elseif identityInfo.policeApproveStatus == 1 && identityInfo.rensheAcceptStatus == 3}
                                    <span>公安审核中</span><br>
                                    <span>人社受理通过</span>
                                {\#elseif identityInfo.policeApproveStatus == 1 && identityInfo.rensheAcceptStatus == 4}
                                    <span>人社受理不通过</span>
                                {\#elseif identityInfo.policeApproveStatus == 2 && (identityInfo.rensheAcceptStatus == 1 || identityInfo.rensheAcceptStatus == 5)}
                                    <span>公安要求补正</span><br>
                                    <span>人社受理审核中</span>
                                {\#elseif identityInfo.policeApproveStatus == 2 && identityInfo.rensheAcceptStatus == 2}
                                    <span>公安要求补正</span><br>
                                    <span>人社要求补正</span>
                                {\#elseif identityInfo.policeApproveStatus == 2 && identityInfo.rensheAcceptStatus == 3}
                                    <span>公安要求补正</span><br>
                                    <span>人社受理通过</span>
                                {\#elseif identityInfo.policeApproveStatus == 2 && identityInfo.rensheAcceptStatus == 4}
                                    <span>人社受理不通过</span>
                                {\#elseif identityInfo.policeApproveStatus == 3 && (identityInfo.rensheAcceptStatus == 1 || identityInfo.rensheAcceptStatus == 5)}
                                    <span>公安审核通过</span><br>
                                    <span>人社受理审核中</span>
                                {\#elseif identityInfo.policeApproveStatus == 3 && identityInfo.rensheAcceptStatus == 2}
                                    <span>公安审核通过</span><br>
                                    <span>人社要求补正</span>
                                {\#elseif identityInfo.policeApproveStatus == 3 && identityInfo.rensheAcceptStatus == 3}
                                    <span>公安审核通过</span><br>
                                    <span>人社受理通过</span>
                                {\#elseif identityInfo.policeApproveStatus == 3 && identityInfo.rensheAcceptStatus == 4}
                                    <span>人社受理不通过</span>
                                {\#elseif identityInfo.policeApproveStatus == 4 && (identityInfo.rensheAcceptStatus == 1 || identityInfo.rensheAcceptStatus == 5)}
                                    <span>公安审核不通过</span>
                                {\#elseif identityInfo.policeApproveStatus == 4 && identityInfo.rensheAcceptStatus == 2}
                                    <span>公安审核不通过</span>
                                {\#elseif identityInfo.policeApproveStatus == 4 && identityInfo.rensheAcceptStatus == 3}
                                    <span>公安审核不通过</span>
                                {\#elseif identityInfo.policeApproveStatus == 4 && identityInfo.rensheAcceptStatus == 4}
                                    <span>公安审核不通过</span><br>
                                    <span>人社受理不通过</span>
                                {\#elseif identityInfo.hallStatus == 2}
                                    <span>公安前置预审通过</span>
                                {\#elseif identityInfo.hallStatus == 3}
                                    <span>人社受理待审核</span>
                                {\#elseif identityInfo.hallStatus == 4}
                                    <span>人社受理不通过</span>
                                {\#elseif identityInfo.hallStatus == 5}
                                    <span>人社正式受理通过</span>
                                {\#elseif identityInfo.hallStatus == 6}
                                    <span>人社汇总发布</span>
                                {\#elseif identityInfo.hallStatus == 7}
                                    <span>分数已核算</span>
                                {\#elseif identityInfo.hallStatus == 8}
                                    <span>资格已取消</span>
                                {\#elseif identityInfo.hallStatus == 9}
                                    <span>打分完成</span>
                                {/if}
                                {\#if identityInfo.weijianwei == 2}
                                    <br><span>卫健委待接收</span>
                                {/if}
                                {\#if identityInfo.weijianwei == 3}
                                    <br><span>卫健委完成收件</span>
                                {/if}
                                {\#if identityInfo.weijianwei == 5}
                                    <br><span>卫健委材料待补正</span>
                                {/if}

                                {\#if identityInfo.gongjijin == 2}
                                    <br><span>住房公积金部门待接收</span>
                                {/if}
                                {\#if identityInfo.gongjijin == 3}
                                    <br><span>公积金完成收件</span>
                                {/if}
                                {\#if identityInfo.gongjijin == 5}
                                    <br><span>公积金材料待补正</span>
                                {/if}

                                {\#if identityInfo.zhujianwei == 2}
                                    <br><span>住建委待接收</span>
                                {/if}
                                {\#if identityInfo.zhujianwei == 3}
                                    <br><span>住建委完成收件</span>
                                {/if}
                                {\#if identityInfo.zhujianwei == 5}
                                    <br><span>住建委材料待补正</span>
                                {/if}

                                {\#if identityInfo.guiziju == 2}
                                    <br><span>规自局待接收</span>
                                {/if}
                                {\#if identityInfo.guiziju == 3}
                                    <br><span>规自局完成收件</span>
                                {/if}
                                {\#if identityInfo.guiziju == 5}
                                    <br><span>规自局材料待补正</span>
                                {/if}

                                {\#if identityInfo.tuiyijunren == 2}
                                    <br><span>退役军人待接收</span>
                                {/if}
                                {\#if identityInfo.tuiyijunren == 3}
                                    <br><span>退役军人完成收件</span>
                                {/if}
                                {\#if identityInfo.tuiyijunren == 5}
                                    <br><span>退役军人材料待补正</span>
                                {/if}

                                {\#if identityInfo.jiaowei == 2}
                                    <br><span>教委待接收</span>
                                {/if}
                                {\#if identityInfo.jiaowei == 3}
                                    <br><span>教委完成收件</span>
                                {/if}
                                {\#if identityInfo.jiaowei == 5}
                                    <br><span>教委材料待补正</span>
                                {/if}

                                {\#if identityInfo.minzheng == 2}
                                    <br><span>民政局待接收</span>
                                {/if}
                                {\#if identityInfo.minzheng == 3}
                                    <br><span>民政局完成收件</span>
                                {/if}
                                {\#if identityInfo.minzheng == 5}
                                    <br><span>民政局材料待补正</span>
                                {/if}

                                {\#if identityInfo.renshe == 2}
                                    <br><span>人社局待接收</span>
                                {/if}
                                {\#if identityInfo.renshe == 3}
                                    <br><span>人社局完成收件</span>
                                {/if}
                                {\#if identityInfo.renshe == 5}
                                    <br><span>人社局材料待补正</span>
                                {/if}

                                {\#if identityInfo.gongan == 2}
                                    <br><span>公安局待接收</span>
                                {/if}
                                {\#if identityInfo.gongan == 3}
                                    <br><span>公安局完成收件</span>
                                {/if}
                                {\#if identityInfo.gongan == 5}
                                    <br><span>公安局材料待补正</span>
                                {/if}
                                <!--<span>预约成功</span>-->
                            {/if}
                            {\#if identityInfo.unionApproveStatus1 == 4 || identityInfo.unionApproveStatus2 == 4}
                                {\#if identityInfo.reservationStatus != 9}
                                    <span>待补件</span>
                                {/if}
                            {/if}
                        </td>
                        <td>
                            {\#if identityInfo.reservationStatus == 1 || identityInfo.reservationStatus == 6 || (identityInfo.reservationStatus == 5 && identityInfo.autoTestNum > 0)}
                                <span class="integral-table-btn integral-table-btn1 edit" onclick="deleteIdentityInfo({identityInfo.id})">删除</span>
                            {/if}

                            {\#if identityInfo.saveStatus == 1  }
                                <span class="integral-table-btn integral-table-btn1 edit" onclick="saveIdentityInfo({identityInfo.id})">补录</span>
                            {/if}

                            {\#if identityInfo.reservationStatus == 1 || identityInfo.reservationStatus == 6 || (identityInfo.reservationStatus == 5 && identityInfo.autoTestNum > 0)}
                            <span class="integral-table-btn integral-table-btn1 edit" onclick="editIdentityInfo({identityInfo.id})">编辑</span>
                            {/if}
                            {\#if identityInfo.reservationStatus == 9 || identityInfo.reservationStatus == 10 || identityInfo.reservationStatus == 11 || (identityInfo.reservationStatus == 5 && identityInfo.autoTestNum == 0)}
                            <span class="integral-table-btn integral-table-btn2 view" onclick="evaluationView({identityInfo.id})"> 查看</span>
                            {/if}
                            {\#if identityInfo.rensheAcceptStatus == 4}
                            <span class="integral-table-btn integral-table-btn2 view" onclick="showReason('{identityInfo.rejectReason}')">不通过原因</span>
                            {/if}
                            {\#if identityInfo.reservationStatus == 6}
                                <span class="integral-table-btn integral-table-btn2" onclick="uploadFile({identityInfo.id})">材料上传</span>
                            {/if}
                            {\#if identityInfo.reservationStatus == 6}
                                <span class="integral-table-btn integral-table-btn2" onclick="reservationLocation({identityInfo.id})">申请审核</span>
                            {/if}
                            {\#if identityInfo.reservationStatus == 1 || (identityInfo.reservationStatus == 5 && identityInfo.autoTestNum > 0)}
                                <span class="integral-table-btn integral-table-btn2" onclick="autoTest({identityInfo.id})">测评</span>
                            {/if}
                            {\#if identityInfo.reservationStatus == 10}
                                {\#if identityInfo.reservationTime > 0}
                                    <span class="integral-table-btn integral-table-btn2" onclick="reservationTime({identityInfo.id})">预约时间</span>
                                {/if}
                            {/if}

                            <!--2019年12月27日，去掉“取消预约”按钮-->
                            <!--{\#if identityInfo.reservationStatus == 11}
                                {\#if identityInfo.hallStatus < 4 && identityInfo.hallStatus != 1}
                                <span class="integral-table-btn integral-table-btn2" onclick="cancalReservation({identityInfo.id})">取消预约</span>
                                {/if}
                            {/if}-->

                            {\#if identityInfo.reservationStatus == 11}
                                {\#if identityInfo.hallStatus < 4 && identityInfo.hallStatus != 1}
                                    <!--<span class="integral-table-btn integral-table-btn2 print" onclick="printReservation({identityInfo.id})">打印</span>-->
                                {/if}
                            {/if}
                            {\#if identityInfo.unionApproveStatus1 == 4 || identityInfo.unionApproveStatus2 == 4  || identityInfo.materialStatus == 1 ||
                                    identityInfo.reservationStatus == 7 || identityInfo.reservationStatus == 8 || identityInfo.reservationStatus == 10 || identityInfo.reservationStatus == 11}
                                {\#if identityInfo.reservationStatus != 9}
                                    <!-- 2019年7月11日，
                                    前台网站，申请人通过在线测评之后，申请人列表——操作中加入“已上传材料”按钮，此按钮一直存在，
                                    即申请人可随时查看自己的材料情况。材料上传、补正等功能都整合进这个按钮。 -->
                                    <span class="integral-table-btn integral-table-btn2" onclick="reUpload({identityInfo.id})">已上传材料</span>
                                    <!--<span class="integral-table-btn integral-table-btn2" onclick="followUp({identityInfo.id})">修改随迁信息</span>-->
                                {/if}
                            {/if}
                        </td>
                    </tr>
                    {/list}
                </table>



            </script>
        </div>
        <!-- 分页器插件 -->
        <div class="integral-paging-device-wrap2 m-style"></div>
    </div>
</div>

<div id="printContent" style="display: none;"></div>
<!-- 底部栏 footer -->
#parse("common/footer.html")
</body>
<script type="text/javascript">
    $(function () {
        $(".scoreMenu>p").click();
        newCurrPage("identityList");

        component.load();
        component.$inject('#app');

        $("#addApplication").on("click", function () {
            /*var time= $.ajax({async: false}).getResponseHeader("Date");
             var date = new Date(time);
             var finishDate = "2018-10-30 17:00";
             finishDate = finishDate.replace(/-/g,"/");
             var date2 = new Date(finishDate);
             if(date2<date){
             layer.msg('2018年第二期居住证积分受理阶段网上注册、预审已经关闭。积分结果将在12月公布，具体时间请关注网站通知。');
             return false;
             }*/

            $.ajax({
                type: "POST",
                url: "${rc.contextPath}/identityInfo/sys/getCloseRegisterTime",
                data: null,
                dataType: "json",
                success: function (result) {
                    if(result.code == 11){
                        layer.msg(result.message);
                        return false;
                    }else{
                        /*
                         读取后台的参数，获得关闭、打开注册、申请人填写、评审、预测等功能的时间；
                         */
                        var flag = false;
                        $.ajax({
                            type: "POST",
                            url: "${rc.contextPath}/identityInfo/sys/getCloseOrOpenFunTime",
                            data: null,
                            dataType: "json",
                            success: function (result) {
                                if (result.code == 20) {//后台定义的20为
                                    flag = true;
                                    if(flag){
                                        layer.msg(result.message);
                                        return false;
                                    }
                                }else{
                                    window.open("${rc.contextPath}/identityInfo/applicationAdd.html");
                                }
                            }
                        });
                    }
                }})

        });
    });

    //利用Regular构建你的app吧
    var identityRowsRegular = Regular.extend({
        template: '#identityRows'
    });

    // initialize component then $inject to #app's  bottom
    var component = new identityRowsRegular({
        data: {identityInfos: []},
        load: function (data) {
            var queryStr = $("input[name=queryStr]").val();

            if (queryStr == undefined) {
                queryStr = "";
            }
            //loading层
            var index = layer.load(1, {
                shade: [0.2, '#000'] //0.1透明度的白色背景
            });

            var pageCount = list(1, queryStr);
            showPage(pageCount);

            layer.close(index);
        }
    });

    /**
     * 分页callback
     * @param page_index
     * @param jq
     */
    function pageCallback(pageInfo) {
        var pageCount = list(pageInfo.getCurrent(), $("input[name=queryStr]").val());
        pageInfo.setPageCount(pageCount);
    }

    function list(page_index, queryStr) {
        var pageCount = 0;
        postSyncResultData("${rc.contextPath}/identityInfo/list", {
            "queryStr": queryStr,
            "pageNo": page_index
        }, function (result) {
            component.data.identityInfos = result.data;
            console.log(result.countmsg);
            $("#remain").html(result.countmsg);
            component.$update();
            pageCount = result.pageCount;
        });

        return pageCount;
    }

    /**
     * 预约地点
     * @param id
     */
    function reservationLocation(id) {

        /*var time= $.ajax({async: false}).getResponseHeader("Date");
         var date = new Date(time);
         var finishDate = "2018-10-30 17:00";
         finishDate = finishDate.replace(/-/g,"/");
         var date2 = new Date(finishDate);
         if(date2<date){
         layer.msg('2018年第二期居住证积分受理阶段网上注册、预审已经关闭。积分结果将在12月公布，具体时间请关注网站通知。');
         return false;
         }*/

        /*
         读取后台的参数，获得关闭、打开注册、申请人填写、评审、预测等功能的时间；
         */
        var flag = false;
        $.ajax({
            type: "POST",
            url: "${rc.contextPath}/identityInfo/sys/getCloseOrOpenFunTime",
            data: null,
            dataType: "json",
            success: function (result) {
                if(result.code == 11){
                    layer.msg(result.message);
                    return false;
                }else if (result.code == 20) {//后台定义的20为
                    flag = true;
                    if(flag){
                        layer.msg('此时间段不受理积分落户，详情请关注重要通知！');
                        return false;
                    }
                }else {
                    //询问框
                    var index = layer.confirm('进入审核后，您所填写的所有信息和上传的所有材料都不能进行主动修改，请确认所有信息及图片完整、准确、真实、有效，确认申请人社会保险缴纳单位与申报单位一致，否则由此产生的一切后果由申请单位申请人承担。确定要申请审核吗？', {
                        btn: ['确认申请审核', '暂不申请审核'] //按钮
                    }, function () {


                        $.ajax({
                            type: "POST",
                            url: "${rc.contextPath}/identityInfo/testAll",
                            data: {"identityInfoId":id},
                            dataType: "json",
                            success: function (result) {
                                if(result.code == 1005) {
                                    layer.msg('第5页，本人及配偶承诺目前未政策外生育（或收养）第三个及以上子女，未处于政策外怀孕第三个及以上子女 没有勾选！');
                                    return false;
                                }
                                if(result.code == 500){
                                    layer.msg('请先点击编辑按钮，完善信息后，操作下一步！');
                                    return false;
                                }else{
                                    /*
                                     2019年12月26日
                                     1、流程修改，申请人点击“申请审核”按钮后，不再跳转到预约地点页面，即注释掉下面的window.open.....
                                     2、去掉公安预审、人社预审两个阶段，直接跨度到公安前置审核；
                                     3、之后的点击“预约时间”按钮也去掉：
                                     1、预约人数的：天津市政务服务中心，每天允许260个申请人；滨海新区政务服务中心，每天允许160个申请人
                                     2、预约现场审核的时间：变为申请人点击这个审核按钮的时间 new date() 生成；
                                     4、后续不变
                                     */
                                    //window.open("${rc.contextPath}/reservation/reserveLocation/" + id + ".html");
                                    // 申请审核
                                    postResult("${rc.contextPath}/identityInfo/examineAndVerify", {"id": id}, function (data) {
                                        component.load();
                                        layer.alert(data.message);
                                    });
                                    layer.close(index);
                                }
                            }
                        });


                    }, function () {
                        layer.close(index);
                    });
                }
            }
        });
    }

    /**
     * “删除”按钮
     * @param id
     */
    function deleteIdentityInfo(id) {

        $.ajax({
            type: "POST",
            url: "${rc.contextPath}/identityInfo/sys/getCloseRegisterTime",
            data: null,
            dataType: "json",
            success: function (result) {
                if(result.code == 11){
                    layer.msg(result.message);
                    return false;
                }else {
                    /*
                     读取后台的参数，获得关闭、打开注册、申请人填写、评审、预测等功能的时间；
                     */
                    var flag = false;
                    $.ajax({
                        type: "POST",
                        url: "${rc.contextPath}/identityInfo/sys/getCloseOrOpenFunTime",
                        data: null,
                        dataType: "json",
                        success: function (result) {
                            if (result.code == 20) {//后台定义的20为
                                flag = true;
                                if(flag){
                                    layer.msg('此时间段不受理积分落户，详情请关注重要通知！');
                                    return false;
                                }
                            }else {
                                //询问框
                                var index = layer.confirm('确定要删除吗？', {
                                    btn: ['确认', '取消'] //按钮
                                }, function () {

                                    /*
                                     2020年1月19日
                                     根据申请人id， 删除信息
                                     */
                                    // 申请审核
                                    postResult("${rc.contextPath}/identityInfo/deleteIdentityInfo", {"id": id}, function (data) {
                                        component.load();
                                        layer.alert(data.message);
                                    });


                                    layer.close(index);
                                }, function () {
                                    layer.close(index);
                                });
                            }
                        }
                    });
                }
            }

        });

    }

    /**
     * 预约时间
     * @param id
     */
    function reservationTime(id) {
        var flag = false;
        $.ajax({
            type: "POST",
            url: "${rc.contextPath}/identityInfo/sys/getCloseOrder",
            data: null,
            dataType: "json",
            success: function (result) {
                if (result.code == 20) {//后台定义的20为
                    flag = true;
                    if(flag){
                        layer.msg('此时间段不受理积分落户，详情请关注重要通知！');
                        return false;
                    }
                }else {
                    //询问框
                    var index = layer.confirm('确定要预约时间吗？', {
                        btn: ['确认', '取消'] //按钮
                    }, function () {
                        window.open("${rc.contextPath}/reservation/reserveTime/" + id + ".html");
                        layer.close(index);
                    }, function () {
                        layer.close(index);
                    });
                }
            }
        });

    }

    /**
     * 自助评测
     * @param id
     */
    function autoTest(id) {
        /*var time= $.ajax({async: false}).getResponseHeader("Date");
         var date = new Date(time);
         var finishDate = "2018-10-30 17:00";
         finishDate = finishDate.replace(/-/g,"/");
         var date2 = new Date(finishDate);
         if(date2<date){
         layer.msg('2018年第二期居住证积分受理阶段网上注册、预审已经关闭。积分结果将在12月公布，具体时间请关注网站通知。');
         return false;
         }*/
        /*
         读取后台的参数，获得关闭、打开注册、申请人填写、评审、预测等功能的时间；
         */
        $.ajax({
            type: "POST",
            url: "${rc.contextPath}/identityInfo/sys/getCloseOrOpenFunTime",
            data: null,
            dataType: "json",
            success: function (result) {
                if (result.code == 20) {//后台定义的20为
                }
            }
        });

        //询问框
        var index = layer.confirm('确定要自助评测吗？', {
            btn: ['确认', '取消'] //按钮
        }, function () {
            window.open("${rc.contextPath}/identityInfo/autoEvaluation/" + id + ".html");
            layer.close(index);
        }, function () {
            layer.close(index);
        });
    }

    /**
     * 查看自助评测信息
     * @param id
     */
    function evaluationView(id) {
        window.open("${rc.contextPath}/identityInfo/selectIdentityInfo/" + id + ".html");
    }

    /**
     * 修改申请人信息
     *
     * @param id
     */
    function editIdentityInfo(id) {
        var flag = false;
        postSyncResult("${rc.contextPath}/identityInfo/validateAutoTest/" + id + ".html", {}, function (data) {
            flag = true;
        });

        if (flag) {
            //询问框
            var index = layer.confirm('确定要修改申请人信息吗？', {
                btn: ['确认', '取消'] //按钮
            }, function () {
                window.open("${rc.contextPath}/identityInfo/editIdentityInfo/" + id + ".html");
                layer.close(index);
            }, function () {
                layer.close(index);
            });
        }
    }

    /**
     * 取消预约
     *
     * @param id
     */
    function cancalReservation(id) {
        //询问框
        var index = layer.confirm('确定要取消预约吗？', {
            btn: ['确认', '取消'] //按钮
        }, function () {

            //取消预约
            postResult("${rc.contextPath}/identityInfo/cancalReservation", {"id": id}, function (data) {
                component.load();
                layer.alert(data.message);
            });
            layer.close(index);
        }, function () {
            layer.close(index);
        });

    }

    /**
     * 材料上传
     *
     * @param id
     */
    function uploadFile(id) {
        /*
         读取后台的参数，获得关闭、打开注册、申请人填写、评审、预测等功能的时间；
         */
        var flag = false;
        $.ajax({
            type: "POST",
            url: "${rc.contextPath}/identityInfo/sys/getCloseOrOpenFunTime",
            data: null,
            dataType: "json",
            success: function (result) {
                if (result.code == 20) {//后台定义的20为
                    flag = true;
                    if(flag){
                        layer.msg('此时间段不受理积分落户，详情请关注重要通知！');
                        return false;
                    }
                }else {
                    //询问框
                    var index = layer.confirm('确定要上传材料吗？', {
                        btn: ['确认', '取消'] //按钮
                    }, function () {

                        $.ajax({
                            type: "POST",
                            url: "${rc.contextPath}/identityInfo/testAll",
                            data: {"identityInfoId":id},
                            dataType: "json",
                            success: function (result) {
                                if(result.code == 1005) {
                                    layer.msg('第5页，本人及配偶承诺目前未政策外生育（或收养）第三个及以上子女，未处于政策外怀孕第三个及以上子女 没有勾选！请 编辑 完善个人信息！');
                                    return false;
                                }
                                if(result.code == 500){
                                    layer.msg('请先点击编辑按钮，完善信息后，操作下一步！');
                                    return false;
                                }else{
                                    window.open("${rc.contextPath}/materialInfo/updateFile/" + id + ".html");
                                    layer.close(index);
                                }
                            }
                        });

                    }, function () {
                        layer.close(index);
                    });
                }
            }
        });

    }

    /**
     * 重新上传材料
     * @param id
     */
    function reUpload(id) {
        //询问框
        var index = layer.confirm('确定要查看上传材料吗？', {
            btn: ['确认', '取消'] //按钮
        }, function () {
            window.open("${rc.contextPath}/materialInfo/updateFile/" + id + ".html");
            layer.close(index);
        }, function () {
            layer.close(index);
        });
    }

    /**
     * 打印预约凭证
     *
     * @param id
     */
    function printReservation(id) {
        //询问框
        var index = layer.confirm('确定要打印预约凭证吗？', {
            btn: ['确认', '取消'] //按钮
        }, function () {
            getResultData("${rc.contextPath}/identityInfo/printReservation/" + id + ".html", {}, function (data) {
                var _template = $('<div></div>');
                _template.html(data);

                _template.print({
                    globalStyles: true,
                    mediaPrint: false,
                    stylesheet: null,
                    noPrintSelector: ".no-print",
                    iframe: true,
                    append: null,
                    prepend: null,
                    manuallyCopyFormValues: true,
                    deferred: $.Deferred()
                });
            });
            layer.close(index);
        }, function () {
            layer.close(index);
        });
    }


    // 2020年4月18日，因有少部分申请人没有填写这个字段，加一个弹窗用来收集补充这个字段值，第5页卫健委的字段值：本人及配偶承诺目前未政策外生育（或收养）第三个及以上子女，未处于。。。
    function saveIdentityInfo(id) {
        var index = layer.confirm("<div class='layui-input-block'>" +
            "<table class='integral-cont-table' style='margin: 20px 20px;'>" +
            "<tr>" +
            "<td>" +
            "<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本人及配偶承诺目前未政策外生育（或收养）第三个及以上子女，未处于政策外怀孕第三个及以上子女</span>" +
            "</td>" +
            "</tr>" +
            "<tr>" +
            "<td>" +
            "<input class='input_radio' type='radio' style='margin-left: 190px;' name='thirdPregnantPromiseOpen' value='1'><label>是</label>" +
            "<input class='input_radio ml30' type='radio' name='thirdPregnantPromiseOpen' value='2'><label>否</label>" +
            "</td>" +
            "</tr>" +
            "</table>" +
            "</div>",
            {
                type: 1,
                skin: 'layui-layer-rim layui-layer-molv',
                title: "请认真阅读并勾选",
                btn: ['确认'],
                area: ['500px', '290px']
            }, function (index, layero) {
                var thirdPregnantPromiseValue = $("input[name='thirdPregnantPromiseOpen']:checked").val();
                if (thirdPregnantPromiseValue != undefined) {
                    $.ajax({
                        url: "${rc.contextPath}/identityInfo/saveIdentityInfo",
                        data:{"identityInfoId":id , "thirdPregnantPromiseValue":thirdPregnantPromiseValue},
                        type: 'post',
                        dataType: 'json',
                        success: function (result) {
                            layer.close(index);
                            component.load();
                        }, error: function (result) {
                            layer.alert(result.message);
                            layer.close(index);
                            component.load();
                        }
                    });
                } else {
                    layer.msg('请选择是或否', {
                        type: 1
                    });
                    return false;
                }

            });
    }

    /**
     * 查看不通过原因
     *
     * @param reason
     */
    function showReason(rejectReason) {
        if(rejectReason) {
            layer.alert(rejectReason, {
                skin: 'layui-layer-lan'
                ,closeBtn: 0
            });
        } else {
            layer.alert('不通过原因为空!!!', {
                skin: 'layui-layer-lan'
                ,closeBtn: 0
            });
        }
    }

    /**
     * 修改随迁信息
     *
     * @param id
     */
    function followUp(id) {
        getResultData("${rc.contextPath}/identityInfo/getFollowUpInfo/" + id + ".html", {}, function (datas) {
            var _template = $('<div></div>');
            var html = [];
            html.push('<div style="overflow-y:auto; height:400px;">');
            html.push('<table class="integral-table border-add integral-cont-table houseRelationships">');
            html.push('<tr>');
            html.push('<th>与本人关系</th><th>姓名</th><th width="281">身份证号</th><th width="100">是否随迁</th><th>文化程度</th>');
            html.push('</tr>');
            for(var i=0; i<datas.length; i++) {
                var data = datas[i];
                html.push('<tr class="houseRelationship" attr_id="'+ data.id +'">');
                html.push('<td>'+ data.relationship +'</td>');
                html.push('<td>' + data.name + '</td>');
                html.push('<td>' + data.idNumber + '</td>');
                html.push('<td>');
                if(data.isRemove == 1) {
                    html.push('<input type="radio" name="isRemove'+i+'" value="1" id="isRemove1'+ i +'" checked>');
                } else {
                    html.push('<input type="radio" name="isRemove'+i+'" value="1" id="isRemove1'+ i +'">');
                }
                html.push('<label for="isRemove1'+i+'">是</label>');
                if(data.isRemove == 2) {
                    html.push('<input class="m15" type="radio" name="isRemove'+i+'" value="2" id="isRemove2'+i+'" checked>');
                } else {
                    html.push('<input class="m15" type="radio" name="isRemove'+i+'" value="2" id="isRemove2'+i+'">');
                }
                html.push('<label for="isRemove2'+i+'">否</label>');
                html.push('</td>');
                html.push('<td>' + data.cultureDegree + '</td>');
                html.push('</tr>');
            }
            html.push('</table>');
            html.push('</div>');

            var content = html.join('');

            //自定页
            var index = layer.open({
                type: 1,
                title: '修改随迁信息',
                skin: 'layui-layer-demo', //样式类名
                closeBtn: 1, //不显示关闭按钮
                area: ['1000px', 'auto'],
                anim: 2,
                shadeClose: true, //开启遮罩关闭
                content: content, //内容
                btn: ['保存', '取消']
                ,yes: function(index, layero){//保存
                    var houseRelationships = [];
                    $(".houseRelationship").each(function(){
                        var id = $(this).attr("attr_id");
                        var isRemove = $(this).find("input[type=radio]:checked").val();
                        houseRelationships.push({"id":id, "isRemove": isRemove});
                    });

                    var houseRelationshipsJson = JSON.stringify(houseRelationships);
                    postResult("${rc.contextPath}/identityInfo/updateHouseRelationships", {"houseRelationshipsJson" : houseRelationshipsJson}, function(data){
                        layer.msg(data.message);
                        layer.close(index);
                    });
                }
                ,btn2: function(index){//取消
                    layer.close(index);
                }
            });
        });
    }
</script>

</html>

