<!DOCTYPE html>
<html lang="en">
<head>
    <title>申请人材料上传</title>
    #parse("common/header.html")
</head>

<body>
<!-- banner和title部分 -->
#parse("common/banner.html")

<!-- 主体部分 -->
<div class="integral-main-box" style="width: 1350px;">
    <div class="integral-cont" style="width: 1300px;">
        <!-- 申请人材料上传 -->
        <!-- 示例title 面包屑导航 -->
        <div class="integral-grey-title-bar">
            <div class="title-bar-head title-bar-cjwt">申请人材料上传</div>
        </div>
        <!-- 内容描述title -->
        <div class="integral-desc-title">
            申请人材料上传
        </div>
        <div class="color-black" style="font-size: 16px;padding: 5px 5px 5px 75px;">
            1、申请人和申请单位请备齐全部材料再进行网上申请、上传材料。（网上上传材料要求：请勿使用手机最低像素模式拍摄，请在光线明亮的环境下，使用白色背景满屏拍摄图片并上传，或将材料扫描并上传，上传图片大小不超过3M，上传图片应清晰、完整、有效，窗口办理时各负责部门核验的原件应与网上上传的材料一致。）
        </div>
        <div class="color-black" style="font-size: 16px;padding: 5px 5px 5px 75px;">
            2、申请人和申请单位请按照材料清单内容据实准备材料。窗口办理时如有需要，请配合提交材料原件。
        </div>
        <div class="color-red" style="font-size: 14px;padding: 5px 5px;">
            温馨提示：1.目前上传材料只支持照片格式，大小不要超过3M。
        </div>
        <div class="color-red" style="font-size: 14px;padding: 5px 5px 5px 75px;">
            2.以下材料项未上传的，视为不提交此项材料，受理期内不再接受材料补充。
        </div>

        <div class="color-red" style="font-size: 14px;padding: 5px 5px 5px 75px;">
            3.居住证必须上传，如未上传，不能申请预审。
        </div>
<!--        <div class="color-red" style="font-size: 14px;padding: 5px 5px 5px 75px;">
            6.卫健委材料上传注意事项：上传申请人签字后的承诺书
            <br>&nbsp;&nbsp;&nbsp;申请人应正确提交承诺书，有以下情况之一的视为承诺书无效：1.承诺书未签字或非本人签字的；2.填写内容无法正确识别的；3.其他不规范承诺的情形。

        </div>-->
        <div class="color-red" style="font-size: 14px;padding: 5px 5px 5px 75px;">
            4.符合以下任意一项条件的，必须上传结婚证：
            <br>&nbsp;&nbsp;&nbsp;(1).有子女随迁落户；
            <br>&nbsp;&nbsp;&nbsp;(2).获取“婚姻状况”积分，夫妻双方均在本市就业，配偶缴纳社会保险满24个月（※注意：同时必须上传配偶身份证原件正反面）；
            <br>&nbsp;&nbsp;&nbsp;(3).获取“住房”积分，且住房为夫妻共有产权住房。
        </div>
        <div class="color-red" style="font-size: 14px;padding: 5px 5px 5px 75px;">
            5.请经办人到办理指南查阅当年材料清单，确保材料提交完整。
        </div>
        <div class="color-red" style="font-size: 14px;padding: 5px 5px 5px 75px;">
            6.根据自身住房的情况、所有权上传自己的材料：
            <br>&nbsp;&nbsp;&nbsp;材料说明：
            <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1、“不动产权证”包括：《天津市不动产权证》、《天津市房地产权证》、《天津市房屋所有权证》等有效证件。证载土地信息不全或无土地信息，需提供由房产所在区县不动产登记部门开具的“天津市不动产登记薄查询证明”；
            <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2、“不动产共有权证”包括：《天津市不动产共有权证》、《天津市房地产共有权证》、《天津市房屋共有权证》等有效证件；
            <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3、共有子女身份证：未成年人无身份证可用户口簿替代身份证；
            <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4、亲属关系相关证明：同一户籍可确定双方关系的，需提供户口簿；同一户籍无法确定双方关系的，需提供相关证明；亲属关系的相关证明可去子女一方户籍所在地公安部门查询户籍登记底档，将亲属关系页复印后，以复印件办理审核即可；
            <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5、亲属关系——户口簿：共有子女身份证：未成年人无身份证可用户口簿替代身份证；
            <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6、契税：全称为“中华人民共和国契税完税证”或“中华人民共和国税收缴款书”，原件破损、污迹、涂改无效；若契税丢失或有涂改污迹破损而无效，需由房主本人持本人身份证及不动产权证，到房产所在地不动产登记部门，申请查档，将房管局留存的契税底档复印，并加盖档案查询章，或由房主本人持本人身份证及不动产权证，到房产所在地税务部门，申请查档，由税务部门出具查询结果证明；
        </div>&nbsp;&nbsp;&nbsp;
        <input type="hidden" name="identityInfoId" id="identityInfoId" value="$!{identityInfo.id}"/>
        <!-- 政策表格 -->
        <table class="integral-table" id="materialTable">
            <thead>
            <tr>
                <th style="width: 8%">分类</th>
                <!--<th style="width: 10%">上传材料项</th>-->
                <th style="width: 22%">材料清单</th>
                <th style="width: 8%">上传说明</th>
                <th style="width: 8%">操作</th>
                <th style="width: 8%">上传查看</th>
                <th style="width: 8%">模板样式</th>
                <th style="width: 8%">删除</th>
                <th style="width: 20%">提示信息</th>
            </tr>
            </thead>
            <tbody id="materialTableTbody">
            #foreach(${materialInfo} in ${materialInfos})
            <tr class="materialInfoTr">
                <td>$!{materialInfo.category}</td>
                <!--<td>$!{materialInfo.categoryRenshe}</td>-->
                <td>
                    <input type="hidden" name="id" value="$!{materialInfo.onlinePersonMaterial.id}"/>
                    <input type="hidden" name="materialInfoId" value="$!{materialInfo.id}"/>
                    ${materialInfo.name}
                </td>
                <td>
                    #if("$!{materialInfo.note}" != "")
                    <a class="integral-table-btn integral-table-btn2 viewTemplate"
                       onclick="layer.alert('$!{materialInfo.note}');">上传说明</a>
                    #else
                    <a class="integral-table-btn integral-table-btn2 viewTemplate"
                       onclick="layer.msg('暂无');">上传说明</a>
                    #end
                </td>
                <td>
                    <span class="attachmentName">$!{materialInfo.onlinePersonMaterial.materialName}</span>
                    <input type="hidden" name="materialId" value="$!{materialInfo.onlinePersonMaterial.materialId}"/>
                    #if(($!{reUpload} == 0) or ($!{reUpload} == 1 and $!{materialInfo.onlinePersonMaterial.status} == 1))
                    <span class="integral-table-btn td_upload integral-table-btn2">上传</span>
                    <input class="upload_input" type="file" id="updateFile_${velocityCount}" name="updateFile"
                           style="display: none"
                           accept="image/*"/>
                    #end
                </td>
                <td>
                    <a class="integral-table-btn integral-table-btn2 viewFile" href="javascript:void(0);"
                       uri="$!{materialInfo.onlinePersonMaterial.materialUri}">查看</a>
                </td>
                <td><a class="integral-table-btn integral-table-btn2 viewTemplate" herf="javascript:void(0);"
                       templateImg="$!{materialInfo.templateImg}">查看模板</a></td>
                <td>
                    #if(($!{reUpload} == 0) or ($!{reUpload} == 1 and $!{materialInfo.onlinePersonMaterial.status} ==
                    1))
                    <a class="integral-table-btn integral-table-btn2 deleteFile">删除</a>
                    #end

                    <!--#if($!{reUpload} == 1 and $!{materialInfo.onlinePersonMaterial.status} == 1)-->
                    <!--<a class="integral-table-btn integral-table-btn2 " href="javascript:void(0);"-->
                       <!--onclick="showReason('$!{materialInfo.onlinePersonMaterial.reason}')">失败原因</a>-->
                    <!--#end-->
                </td>
                <td>
                    #if($!{reUpload} == 1 and $!{materialInfo.onlinePersonMaterial.status} == 1)
                    ${materialInfo.onlinePersonMaterial.reason}
                    #end
                </td>
            </tr>
            #end
            </tbody>
        </table>

        <!-- 验证码和底部按钮 -->
        <table class="check-table">
            <tr>
                <td>
                    <span class="color-red">*</span>验证码：
                </td>
                <td>
                    <input class="integral-input w200" type="text" name="captcha">
                    <div class="checkimg">
                        <img id="captchaImg" src="${rc.contextPath}/captcha.jpg" alt="看不清点我" class="click_me">
                    </div>
                    <span class="click_me">看不清点我</span>
                </td>
            </tr>
        </table>

        <!-- 保存按钮 -->
        <div class="integral-bottom-btn-group mt150">
            <div class="interal-main-btn big-btn m15" id="save">保存</div>
            <div class="interal-main-btn big-btn interal-main-btn2 ml50" id="cancel">返回</div>
        </div>

        <div id="outerdiv"
             style="position:fixed;top:0;left:0;background:rgba(0,0,0,0.7);z-index:2;width:100%;height:100%;display:none;">
            <div id="innerdiv" style="position:absolute;">
                <img id="bigimg" style="border:5px solid #fff;" src=""/>
            </div>
        </div>
    </div>
</div>

<!-- 底部栏 footer -->
#parse("common/footer.html")
</body>
<script type="text/javascript" src="${rc.contextPath}/$static.curr_ver()/js/jquery.form.min.js"></script>
<script type="text/javascript">
    $(function () {
        var materialTableTbody = $('#materialTableTbody');
        var materialTableTbodyClone = materialTableTbody.clone();
        var tempMaterial = {};
        var firstTD = "";
        var secondTD = "";
        materialTableTbodyClone.find('tr').each(function () {
            firstTD = $(this).children('td').eq(0).text();
            secondTD = $(this).children('td').eq(1).text();
            if (!tempMaterial.hasOwnProperty(firstTD)) {
                tempMaterial[firstTD] = {};
            }
            if (!tempMaterial[firstTD].hasOwnProperty(secondTD)) {
                tempMaterial[firstTD][secondTD] = [];
            }
            tempMaterial[firstTD][secondTD].push($(this));
        });


        materialTableTbody.empty();
        var tempTr;
        for (var firstKey in tempMaterial) {
            //分类
            if (tempMaterial.hasOwnProperty(firstKey)) {
                for (var secondKey in tempMaterial[firstKey]) {
                    //上传材料项
                    if (tempMaterial[firstKey].hasOwnProperty(secondKey)) {
                        //材料清单
                        var isFirst = false;
                        if (secondKey == getFirstAttribute(tempMaterial[firstKey])) {
                            isFirst = true;
                        }

                        for (var index in tempMaterial[firstKey][secondKey]) {
                            if (tempMaterial[firstKey][secondKey].hasOwnProperty(index)) {
                                tempTr = tempMaterial[firstKey][secondKey][index];
                                firstTD = tempTr.children('td').eq(0);
                                secondTD = tempTr.children('td').eq(1);
                                var firstKeyLength = 0;
                                var secondKeyLenth = tempMaterial[firstKey][secondKey].length;
                                for (var tempkey in tempMaterial[firstKey]) {
                                    if (tempMaterial[firstKey].hasOwnProperty(tempkey)) {
                                        firstKeyLength += tempMaterial[firstKey][tempkey].length;
                                    }
                                }
                                if (isFirst && index == 0) {
                                    firstTD.attr("rowspan", firstKeyLength);
                                } else {
                                    firstTD.remove();
                                }

                                if (index == 0) {
                                    secondTD.attr("rowspan", secondKeyLenth);
                                } else {
                                    secondTD.remove();
                                }
                                materialTableTbody.append(tempTr);
                            }
                        }
                    }
                }
            }
        }

        var materialTable = $('#materialTable');
        materialTable.css('border', '1px solid #636363');
        materialTable.find("th").each(function () {
            $(this).css('border', '1px solid #636363')
        });
        materialTable.find("td").each(function () {
            $(this).css('border', '1px solid #636363')
        });
        materialTable.find("tr").each(function () {
            $(this).css('border', '1px solid #636363')
        });


        //页面层-自定义
        $(".viewTemplate").on("click", function () {
            var templateImg = $(this).attr("templateImg");

            if (templateImg != '') {
                imgShow("#outerdiv", "#innerdiv", "#bigimg", templateImg);
            } else {
                layer.msg("该材料没有模板,请通知管理员进行上传!!");
            }
        });

        var _updateFileChange = function () {
            var obj = $(this).parent('td');

            var file = document.getElementById($(this).attr("id"));
            var fileSize = 0;
            var fileMaxSize = 3072;//3M
            var filePath = file.value;
            if (filePath) {
                fileSize = file.files[0].size;
                var size = fileSize / 1024;
                if (size > fileMaxSize) {
                    layer.alert("文件大小不能大于3M！请上传清晰图片，不要模糊的，图片命名不要有特殊符号（类似：@#$%^&），否则会被驳回上传的图片！");
                    file.value = "";
                    return false;
                }
                var fileName = file.files[0].name;
                var ext = fileName.substr(fileName.lastIndexOf(".")+1,fileName.length);
                if(!(ext=='png' || ext=='jpg' || ext=='jpeg')){
                    layer.alert("上传的图片文件的格式要求为 jpg、png、jpeg！图片命名不要有特殊符号（类似：@#$%^&）！");
                    return false;
                }
                // 2020年8月11日 图片命名中有特殊符号的不能上传成功
                var pattern = new RegExp("[`~!@#$^&*()=|{}'%:;',\\[\\]<>《》/?~！@#￥……&*（）——|{}【】‘；：”“'。，、？ ]");
                if(pattern.test(fileName)){
                    layer.alert("图片文件名不要有特殊符号（类似：@#$%^&），请重新命名！");
                    return false;
                }

                if(file.files[0].width>2000 || file.files[0].height>2000){
                    layer.alert("上传的图片的尺寸太大，温馨提示，图片的长宽都不得大于2000像素！");
                    return false;
                }

            }

            $.ajaxFileUpload({
                url: '${rc.contextPath}/fileUpload/updateFile', //用于文件上传的服务器端请求地址
                fileElementId: $(this).attr("id"), //文件上传空间的id属性  <input type="file" id="file" name="file" />
                type: 'post',
                dataType: 'text', //返回值类型 一般设置为json
                obj: obj,
                success: function (result, status, obj) //服务器成功响应处理函数
                {

                    var _this = obj;
                    var resultObj = JSON.parse(result);
                    if (!resultObj.code) {
                        _this.find("span.attachmentName").text(resultObj.data.attachmentName);
                        _this.find("input[name=materialId]").val(resultObj.data.attachmentId);
                        _this.next().find("a.viewFile").attr("uri", resultObj.data.attachmentUrl);
                    } else {
                        layer.msg(resultObj.msg);
                    }

                    var file_input = $('<input class="upload_input" type="file" id="' + _this.find('.upload_input').attr("id") + '" name="updateFile" accept="image/*"/>');
                    _this.find("input.upload_input").remove();
                    file_input.on("change", _updateFileChange);
                    file_input.appendTo(_this);
                },
                error: function (result, status, e)//服务器响应失败处理函数
                {
                    layer.msg("图片上传失败");
                }
            });

        };

        //身份证反面上传
        $("input[name=updateFile]").on("change", _updateFileChange);


        /**
         * 查看文件
         */
        $(".viewFile").on("click", function () {
            if ($(this).attr("uri") == '') {
                layer.msg("没有上传文件, 不能查看..");
                return false;
            }

            window.open($(this).attr("uri"));
        });

        /**
         *  删除按钮
         */
        $(".deleteFile").on("click", function () {
            var $tr = $(this).parents("tr.materialInfoTr");

            layer.confirm('是否要删除上传文件？', {
                btn: ['是', '否'] //按钮
            }, function (index) {
                $tr.find("input[name=materialId]").val('');
                $tr.find("span.attachmentName").text('');
                $tr.find(".viewFile").attr("uri", '');

                layer.close(index);
            }, function (index) {
                layer.close(index);
            });

        });

        //保存申请人材料信息
        $("#save").on("click", function () {
            var isupload = true;
            var message = "";

            $('#materialTableTbody').find('tr').each(function () {
                firstTD = $(this).children('td').eq(0);
                if (firstTD.text() == "必传材料") {
                    var rowspan = firstTD.attr("rowspan");
                    var tempObject = $(this);
                    var uploadSpan = tempObject.find(".attachmentName");
                    for (var i = 0; i < parseInt(rowspan); i++) {
                        if (uploadSpan.text().trim() == "") {
                            isupload = false;
                            message = uploadSpan.parent().prev().prev().text();
                            break;
                        } else {
                            tempObject = tempObject.next();
                            uploadSpan = tempObject.find(".attachmentName");
                        }
                    }
                    return false;
                }
            });

            if (isupload) {
                //材料信息封装
                var materialInfoArr = new Array();
                $("tr.materialInfoTr").each(function () {
                    var id = $(this).find("input[name=id]").val();
                    var materialInfoId = $(this).find("input[name=materialInfoId]").val();
                    var materialId = $(this).find("input[name=materialId]").val();

                    if (materialId != '') {
                        materialInfoArr.push({"id": id, "materialInfoId": materialInfoId, "materialId": materialId});
                    }
                });

                /*
                * 2019年8月14日
                * 当申请人上传结婚证后，必须上传配偶的身份证，否则不用上传
                * */
                var marriage_flag_1 = false;
                var marriage_flag_2 = false;
                var spouse_id_flag_1 = false;
                var spouse_id_flag_2 = false;
                for(var i=0;i<materialInfoArr.length;i++){
                    if(materialInfoArr[i].materialInfoId==17){// 结婚证第一页（上传页详见模板）
                        marriage_flag_1 = true;
                    }
                    if (materialInfoArr[i].materialInfoId==1080){ // 结婚证第二页（上传页详见模板）
                        marriage_flag_2 = true;
                    }
                    if(materialInfoArr[i].materialInfoId==18){// 配偶身份证正面
                        spouse_id_flag_1 = true;
                    }
                    if(materialInfoArr[i].materialInfoId==1090){// 配偶身份证反面
                        spouse_id_flag_2 = true;
                    }
                }

//                if (marriage_flag_1 || marriage_flag_2){
//                    if (!(spouse_id_flag_1 && spouse_id_flag_2)){
//                        layer.alert("若上传了结婚证，必须上传配偶身份证的正反面！！");
//                        return false;
//                    }
//                }

                var materialInfoJson = JSON.stringify(materialInfoArr);

                var flag = false;
                postResultData("${rc.contextPath}/materialInfo/saveMaterialInfo", {
                    "materialInfo": materialInfoJson,
                    "identityInfoId": $("#identityInfoId").val(),
                    "captcha": $("input[name=captcha]").val()
                }, function () {
                    flag = true;
                    layer.msg('保存成功，请申请审核；若申请过审核了就忽略此提示!!', {
                        time: 5000
                    }, function () {
                        /*if (window.opener && window.opener.component) {
                         window.opener.component.load();
                         window.close();
                         } else {
                         window.close();
                         }*/
                        window.location.href = "${rc.contextPath}/identityInfo/index.html";
                    });
                });
            } else {
                layer.alert(message + "为必传材料,请上传后保存");
            }
        });
    });

    /**
     * 展示失败原因
     **/
    function showReason(reason) {
        if (reason) {
            layer.alert(reason, {
                skin: 'layui-layer-lan'
                , closeBtn: 0
            });
        } else {
            layer.alert('失败原因为空!!!', {
                skin: 'layui-layer-lan'
                , closeBtn: 0
            });
        }
    }


    function imgShow(outerdiv, innerdiv, bigimg, templateImg) {
        var src = templateImg;//获取当前点击的pimg元素中的src属性
        $(bigimg).attr("src", src);//设置#bigimg元素的src属性

        /*获取当前点击图片的真实大小，并显示弹出层及大图*/
        $("<img/>").attr("src", src).load(function () {
            var windowW = $(window).width();//获取当前窗口宽度
            var windowH = $(window).height();//获取当前窗口高度
            var realWidth = this.width;//获取图片真实宽度
            var realHeight = this.height;//获取图片真实高度
            var imgWidth, imgHeight;
            var scale = 0.8;//缩放尺寸，当图片真实宽度和高度大于窗口宽度和高度时进行缩放

            if (realHeight > windowH * scale) {//判断图片高度
                imgHeight = windowH * scale;//如大于窗口高度，图片高度进行缩放
                imgWidth = imgHeight / realHeight * realWidth;//等比例缩放宽度
                if (imgWidth > windowW * scale) {//如宽度扔大于窗口宽度
                    imgWidth = windowW * scale;//再对宽度进行缩放
                }
            } else if (realWidth > windowW * scale) {//如图片高度合适，判断图片宽度
                imgWidth = windowW * scale;//如大于窗口宽度，图片宽度进行缩放
                imgHeight = imgWidth / realWidth * realHeight;//等比例缩放高度
            } else {//如果图片真实高度和宽度都符合要求，高宽不变
                imgWidth = realWidth;
                imgHeight = realHeight;
            }
            $(bigimg).css("width", imgWidth);//以最终的宽度对图片缩放

            var w = (windowW - imgWidth) / 2;//计算图片与窗口左边距
            var h = (windowH - imgHeight) / 2;//计算图片与窗口上边距
            $(innerdiv).css({"top": h, "left": w});//设置#innerdiv的top和left属性
            $(outerdiv).fadeIn("fast");//淡入显示#outerdiv及.pimg
        });

        $(outerdiv).click(function () {//再次点击淡出消失弹出层
            $(this).fadeOut("fast");
        });
    }

    function getFirstAttribute(data) {
        for (var key in data) {
            if (data.hasOwnProperty(key)) {
                return key;
            }
        }
    }
</script>
</html>
