<!DOCTYPE html>
<html lang="cn">

<title>用人单位修改</title>
#parse("common/header.html")
</head>

<body>
<!-- banner和title部分 -->
#parse("common/banner.html")

<!-- 主体部分 -->
<div class="integral-main-box">
    <!-- 左部导航 -->
    #parse("common/lefter.html")

    <!-- 内容展示区 -->
    <div class="integral-cont">

        <!-- 示例title 面包屑导航 -->
        <div class="integral-grey-title-bar">
            <div class="title-bar-head title-bar-yrdwxg">用人单位修改</div>
        </div>
        <!-- 内容描述title -->
        <div class="integral-desc-title border-bottom">
            用人单位修改
        </div>
        <!-- 用人单位修改表格 -->
        <form id="companyForm">
            <div id="app">
                <script type="text/regular" id="companyInfo">
                <div class="integral-cont-table-wrap">
                    <input type="hidden" name="id" name="id" r-model={companyInfo.id}>
                    <table class="integral-cont-table">
                        <tr>
                            <td>
                                <span class="color-red">*</span>单位名称：
                            </td>
                            <td>
                                <input class="integral-input w450"
                                       placeholder="单位名称必须与营业执照一致" type="text"
                                       name="companyName" r-model={companyInfo.companyName}
                                       disabled="disabled">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="color-red">*</span>单位类型：
                            </td>
                            <td>
                                <input class="input_radio" type="radio" name="companyType"
                                       r-model={companyInfo.companyType} value="1"
                                       disabled="disabled">&nbsp;&nbsp;&nbsp;企事业单位
                                <input class="input_radio ml30" type="radio" name="companyType"
                                       r-model={companyInfo.companyType} value="2"
                                       disabled="disabled">&nbsp;&nbsp;&nbsp;个体商户
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="color-red">*</span>本单位申请人预约地点：
                            </td>
                            <td>
                                <input class="input_radio" type="radio" name="operatorMobile2"
                                       r-model={companyInfo.operatorMobile2} value="1"
                                       disabled="disabled">&nbsp;&nbsp;&nbsp;天津市政务服务中心
                                <input class="input_radio ml30" type="radio" name="operatorMobile2"
                                       r-model={companyInfo.operatorMobile2} value="2"
                                       disabled="disabled">&nbsp;&nbsp;&nbsp;滨海新区政务服务中心
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="color-red">*</span>统一社会信用代码：
                            </td>
                            <td>
                                <input class="integral-input w450"
                                       placeholder="如您没有统一社会信用代码，请输入机构代码" type="text"
                                       name="societyCode" r-model={companyInfo.societyCode}
                                       disabled="disabled">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="color-red">*</span>经办人身份证正面：
                            </td>
                            <td>
                                <div class="integral-businesslicense-img" id="businessLicenseDiv">
                                    <img id="businessLicenseSrcImg" name="businessLicenseSrcImg"
                                         width="180" height="158">
                                         <input id="businessLicenseSrc" name="businessLicenseSrc" type="hidden" value=""/>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                        <span class="color-red">提示：保存成功后，下列用人单位信息每开办一期只可以修改一次。
                        </span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="color-red">*</span>单位联系电话：
                            </td>
                            <td>
                                <input id="companyMobile" class="integral-input w450"
                                       placeholder="" type="text"
                                       name="companyMobile" r-model="{companyInfo.companyMobile}">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="color-red">*</span>经办人：
                            </td>
                            <td>
                                <input id="operator" class="integral-input w450"
                                       placeholder="单位指定办理专员" type="text"
                                       name="operator" r-model={companyInfo.operator}>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="color-red">*</span>经办人联系手机：
                            </td>
                            <td>
                                <input id="operatorMobile" class="integral-input w450"
                                       type="text" name="operatorMobile"
                                       r-model={companyInfo.operatorMobile}>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="color-red">*</span>经办人身份证号：
                            </td>
                            <td>
                                <input id="idCardNumber_1" class="integral-input w450"
                                       type="text" name="idCardNumber_1"
                                       r-model={companyInfo.idCardNumber_1}>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                联系地址：
                            </td>
                            <td>
                                <input id="operatorAddress" class="integral-input w450"
                                       placeholder="" type="text"
                                       name="operatorAddress" r-model={companyInfo.operatorAddress}>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <span class="color-red">*</span>验证码：
                            </td>
                            <td>
                                <input class="integral-input w200" type="text" name="captcha">
                                <div class="checkimg">
                                    <img id="captchaImg" src="${rc.contextPath}/captcha.jpg" alt="看不清点我"
                                         class="click_me">
                                </div>
                                <span class="click_me">看不清点我</span>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <div class="color-red">*注：标有红色 * 为必填项</div>
                            </td>
                        </tr>
                    </table>
                </div>


                </script>
            </div>

            <!-- 保存按钮 -->
            <div class="integral-bottom-btn-group mt150">
                <div class="interal-main-btn big-btn m15" id="save">保存</div>
                <div class="interal-main-btn big-btn interal-main-btn2 ml50" id="cancel">返回</div>
            </div>
        </form>
    </div>
</div>

<!-- 底部栏 footer -->
#parse("common/footer.html")
</body>
<script type="text/javascript">
    //点击注册按钮
    $("#save").on("click", function () {
        $("#companyForm").submit();
    });


    $(function () {
        $(".scoreMenu>p").click();
        newCurrPage("companyEdit");

        $("#companyForm").validate({
            rules: {
                companyName: {
                    required: true,
                    maxlength: 100
                },
                societyCode: {
                    required: true,
                    maxlength: 50
                },
                companyMobile: {
                    required: true,
                    isMobile: true
                },
                operator: {
                    required: true,
                    maxlength: 10
                },
                operatorMobile: {
                    required: true,
                    isMobile: true
                },
                operatorAddress: {
                    maxlength: 100
                }
            },
            messages: {
                companyName: {
                    required: "请输入单位名称",
                    maxlength: "单位名称不能大于 100 个字母"
                },
                societyCode: {
                    required: "请输入统一社会信用代码",
                    maxlength: "密码长度不能大于 50 个字母"
                },
                companyMobile: {
                    required: "请输入单位联系电话"
                },
                operator: {
                    required: "请输入经办人",
                    maxlength: "密码长度不能大于 10 个字母"
                },
                operatorMobile: {
                    required: "请输入联系手机"
                },
                operatorAddress: {
                    required: "请输入联系地址",
                    maxlength: "密码长度不能大于 100 个字母"
                }
            },

            submitHandler: function (form) {
                var index = layer.confirm('每一期的企业信息只能修改一次，确定修改吗？', {
                    btn: ['确认', '取消']
                }, function () {
                    if ($('#businessLicenseSrc').val().trim() != "") {
                        var companyInfo = serializeForm($("#companyForm"));
                        var captcha = companyInfo['captcha'];
                        //移除元素
                        delete companyInfo['captcha'];

                        var societyCode = $("input[name=societyCode]").val();
                        if (!checkSocialCreditCode(societyCode)) {
                            return false;
                        }

                        $.ajax({
                            type: "POST",
                            url: "${rc.contextPath}/companyInfo/companyEdit",
                            data: {"companyInfo": JSON.stringify(companyInfo), "captcha": captcha},
                            dataType: "json",
                            success: function (result) {
                                if (result['code'] == 0) {
                                    location.reload();
                                } else {
                                    layer.alert(result.message);
                                    refreshCode();
                                }
                            }
                        });
                        layer.close(index);
                    } else {
                        layer.alert("请上传营业执照照片！");
                    }
                }, function () {
                    layer.close(index);
                });
            }
        });
    });

    //利用Regular构建你的app吧
    var companyInfoRegular = Regular.extend({
        template: '#companyInfo'
    });

    // initialize component then $inject to #app's  bottom
    var component = new companyInfoRegular({
        data: {companyInfo: {}},
        load: function (data) {
            getResultData("${rc.contextPath}/companyInfo/getCurrCompanyInfo", {}, function (data) {
                if (data.hasOwnProperty("status") && data['status'] == 1) {
                    setDisabled();
                }

                if (data.hasOwnProperty("businessLicenseSrc") && data['businessLicenseSrc'] != null) {
                    $('#businessLicenseSrcImg').attr("src", data['businessLicenseSrc']);
                    $('#businessLicenseSrc').val(data['businessLicenseSrc']);
                } else {
                    layer.alert("请先上传营业执照照片");
                    $('#businessLicenseDiv').empty();
                    $('#businessLicenseDiv').append("<img class=\"addImg pointer\"\n" +
                        "                                     src=\"${rc.contextPath}/$static.curr_ver()/img/yingyezhizhao.png\"\n" +
                        "                                     onclick=\"integral.clickImg(this);\">\n" +
                        "                                <img class=\"preview\" id=\"preview\" alt=\"\" name=\"pic\" width=\"180\" height=\"158\"\n" +
                        "                                     style=\"display: none\"/>\n" +
                        "                                <input id=\"business_license\" name=\"business_license\" type=\"file\" class=\"upload_input\"\n" +
                        "                                       accept=\"image/*\" onchange=\"changeImg(this)\" attr-inp=\"businessLicenseSrc\"/>\n" +
                        "                                <div class=\"pointer title_click\" onclick=\"integral.clickImg(this);\">点击上传营业执照</div>\n" +
                        "                                <div class=\"title_idcard\" style=\"display:none;\">营业执照</div>\n" +
                        "                                <div class=\"del_idcard\" onclick=\"integral.deleteImg(this)\" style=\"display:none;\"></div>\n" +
                        "                                <input id=\"businessLicenseSrc\" name=\"businessLicenseSrc\" type=\"hidden\" value=\"\"/>");
                }
                component.data.companyInfo = data;
                component.$update();
            });
        }
    });

    component.load();

    component.$inject('#app');

    function setDisabled() {
        $('#operator').attr("disabled", "disabled");
        $('#operatorMobile').attr("disabled", "disabled");
        $('#idCardNumber_1').attr("disabled", "disabled");
        $('#companyMobile').attr("disabled", "disabled");
        $('#operatorAddress').attr("disabled", "disabled");
    }

    function checkSocialCreditCode(Code) {
        var patrn = /^[0-9A-Z]+$/;//18位校验及大写校验

        if ((Code.length != 18) || (patrn.test(Code) == false)) {
            layer.alert("不是有效的统一社会信用编码！");
            return false;
        } else {
            var Ancode; //统一社会信用代码的每一个值

            var Ancodevalue; //统一社会信用代码每一个值的权重

            var total = 0;
            var weightedfactors = [1, 3, 9, 27, 19, 26, 16, 17, 20, 29, 25, 13, 8, 24, 10, 30, 28]; //加权因子

            var str = '0123456789ABCDEFGHJKLMNPQRTUWXY';//不用I、O、S、V、Z

            for (var i = 0; i < Code.length - 1; i++) {
                Ancode = Code.substring(i, i + 1);
                Ancodevalue = str.indexOf(Ancode);
                total = total + Ancodevalue * weightedfactors[i];//权重与加权因子相乘之和
            }
            var logiccheckcode = 31 - total % 31;


            if (logiccheckcode == 31) {
                logiccheckcode = 0;
            }
            var Str = "0,1,2,3,4,5,6,7,8,9,A,B,C,D,E,F,G,H,J,K,L,M,N,P,Q,R,T,U,W,X,Y";
            var Array_Str = Str.split(',');
            logiccheckcode = Array_Str[logiccheckcode];


            var checkcode = Code.substring(17, 18);
            if (logiccheckcode != checkcode) {
                layer.alert("不是有效的统一社会信用编码！");
                return false;
            }
        }

        return true;
    }

    function _updateFileChange(fileObj) {
        $.ajaxFileUpload({
            url: '${rc.contextPath}/fileUpload/uploadImage',
            fileElementId: fileObj.attr("id"),
            type: 'post',
            dataType: 'text',
            obj: fileObj,
            success: function (result, status, obj) {
                var resultObj = JSON.parse(result);
                if (!resultObj.code) {
                    $("input[name=" + obj.attr("attr-inp") + "]").val(resultObj.data.attachmentUrl);
                } else {
                    layer.msg(resultObj.message);
                }
            },
            error: function (result, status, e) {
                layer.msg("图片上传失败");
            }
        });
    }

    function changeImg(object) {
        integral.change(object);
        _updateFileChange($(object));
    }

</script>
<style type="text/css">
    .integral-businesslicense-img {
        width: 200px;
        height: 168px;
        float: left;
        background: #FBFCFF;
        text-align: center;
        border: 1px solid #DDDDDD;
        padding: 10px;
        margin-right: 10px;
        position: relative;
    }
</style>
</html>
